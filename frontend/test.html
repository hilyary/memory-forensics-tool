<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Forensics Tool - 测试</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        /* 临时调试样式 */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航栏 -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="#3b82f6"/>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96" stroke="#3b82f6"/>
                        <line x1="12" y1="22.08" x2="12" y2="12" stroke="#3b82f6"/>
                    </svg>
                    <span class="logo-text">Memory Forensics</span>
                </div>
            </div>

            <div class="header-center">
                <div class="status-indicator">
                    <span class="status-dot" id="systemStatusDot"></span>
                    <span class="status-text" id="systemStatusText">初始化中...</span>
                </div>
            </div>

            <div class="header-right">
                <button class="header-btn" id="clearCacheBtn" title="清除缓存">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    </svg>
                </button>
                <button class="header-btn" id="exportBtn" title="导出报告">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- 主内容区域 -->
        <div class="main-container">
            <!-- 左侧边栏 -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="section-title">镜像管理</div>
                    <button class="sidebar-btn primary" id="loadImageBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                        </svg>
                        <span>加载镜像</span>
                    </button>
                </div>

                <div class="sidebar-section">
                    <div class="section-title">进程分析</div>
                    <button class="sidebar-btn" data-plugin="pslist">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        <span>进程列表</span>
                    </button>
                    <button class="sidebar-btn" data-plugin="netscan">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        <span>网络连接</span>
                    </button>
                </div>

                <div class="sidebar-section">
                    <div class="section-title">CTF工具</div>
                    <button class="sidebar-btn accent" id="searchFlagBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                            <path d="M11 8v6M8 11h6"/>
                        </svg>
                        <span>搜索Flag</span>
                    </button>
                </div>
            </aside>

            <!-- 主内容区 -->
            <main class="content">
                <!-- 欢迎页 -->
                <div class="welcome-panel" id="welcomePanel">
                    <div class="welcome-content">
                        <svg class="welcome-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="#3b82f6" stroke-width="1.5"/>
                            <polyline points="3.27,6.96 12,12.01 20.73,6.96" stroke="#3b82f6" stroke-width="1.5"/>
                            <line x1="12" y1="22.08" x2="12" y2="12" stroke="#3b82f6" stroke-width="1.5"/>
                        </svg>
                        <h1 class="welcome-title">内存取证工具</h1>
                        <p class="welcome-subtitle">基于 Volatility 3 的图形化内存分析平台</p>
                        <div class="welcome-features">
                            <div class="feature-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                <span>支持多种内存镜像格式</span>
                            </div>
                            <div class="feature-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                <span>可视化分析结果展示</span>
                            </div>
                            <div class="feature-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                <span>智能缓存提升分析效率</span>
                            </div>
                            <div class="feature-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                <span>CTF竞赛快捷功能</span>
                            </div>
                        </div>
                        <button class="welcome-btn" id="welcomeLoadBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                            </svg>
                            <span>加载内存镜像</span>
                        </button>
                    </div>
                </div>

                <!-- 镜像信息面板 -->
                <div class="image-info-panel hidden" id="imageInfoPanel">
                    <div class="info-card">
                        <div class="info-header">
                            <h3>当前镜像</h3>
                            <div class="image-status">
                                <span class="status-dot active"></span>
                                <span>已加载</span>
                            </div>
                        </div>
                        <div class="info-body">
                            <div class="info-item">
                                <span class="info-label">文件名</span>
                                <span class="info-value" id="imageName">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">大小</span>
                                <span class="info-value" id="imageSize">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">哈希</span>
                                <span class="info-value" id="imageHash">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">路径</span>
                                <span class="info-value" id="imagePath">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 结果展示区 -->
                <div class="results-panel hidden" id="resultsPanel">
                    <div class="results-header">
                        <h2 id="resultsTitle">分析结果</h2>
                        <div class="results-actions">
                            <button class="action-btn" id="exportResults">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                导出
                            </button>
                        </div>
                    </div>

                    <div class="results-stats" id="resultsStats">
                        <div class="stat-item">
                            <span class="stat-value" id="resultCount">0</span>
                            <span class="stat-label">记录数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="executionTime">-</span>
                            <span class="stat-label">执行时间</span>
                        </div>
                    </div>

                    <div class="results-table-container" id="resultsTableContainer">
                        <table class="results-table" id="resultsTable">
                            <thead id="resultsTableHead"></thead>
                            <tbody id="resultsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- 加载指示器 -->
        <div class="loading-overlay hidden" id="loadingOverlay">
            <div class="loading-content">
                <svg class="loading-spinner" viewBox="0 0 50 50">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-dasharray="80" stroke-dashoffset="60">
                        <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/>
                    </circle>
                </svg>
                <p class="loading-text" id="loadingText">分析中...</p>
            </div>
        </div>

        <!-- 通知组件 -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // 简化版本的应用，直接在这里定义
        console.log('=== 开始初始化应用 ===');

        class SimpleApp {
            constructor() {
                this.currentImage = null;
                this.currentResults = null;
                console.log('SimpleApp 构造完成');
            }

            init() {
                console.log('开始初始化...');
                this.bindEvents();
                this.setSystemStatus('演示模式就绪', 'active');
                console.log('初始化完成!');
            }

            bindEvents() {
                console.log('绑定事件...');

                // 加载镜像
                const loadImageBtn = document.getElementById('loadImageBtn');
                const welcomeLoadBtn = document.getElementById('welcomeLoadBtn');

                console.log('loadImageBtn:', loadImageBtn);
                console.log('welcomeLoadBtn:', welcomeLoadBtn);

                if (loadImageBtn) {
                    loadImageBtn.addEventListener('click', () => this.loadImage());
                    console.log('✓ loadImageBtn 事件已绑定');
                }
                if (welcomeLoadBtn) {
                    welcomeLoadBtn.addEventListener('click', () => this.loadImage());
                    console.log('✓ welcomeLoadBtn 事件已绑定');
                }

                // 插件按钮
                document.querySelectorAll('.sidebar-btn[data-plugin]').forEach(btn => {
                    const plugin = btn.dataset.plugin;
                    btn.addEventListener('click', () => this.runPlugin(plugin));
                    console.log('✓ 插件按钮事件已绑定:', plugin);
                });

                // CTF功能
                const searchFlagBtn = document.getElementById('searchFlagBtn');
                if (searchFlagBtn) {
                    searchFlagBtn.addEventListener('click', () => this.searchFlag());
                    console.log('✓ searchFlagBtn 事件已绑定');
                }
            }

            loadImage() {
                console.log('loadImage 被调用');
                this.currentImage = {
                    name: 'demo_memory.raw',
                    size: '128.00 MB',
                    hash: 'abc123...',
                    path: '/path/to/demo_memory.raw'
                };

                document.getElementById('imageName').textContent = this.currentImage.name;
                document.getElementById('imageSize').textContent = this.currentImage.size;
                document.getElementById('imageHash').textContent = this.currentImage.hash;
                document.getElementById('imagePath').textContent = this.currentImage.path;

                document.getElementById('welcomePanel').classList.add('hidden');
                document.getElementById('imageInfoPanel').classList.remove('hidden');

                this.toast('success', '镜像加载成功', '已加载演示镜像');
            }

            runPlugin(pluginId) {
                console.log('runPlugin 被调用:', pluginId);

                if (!this.currentImage) {
                    this.toast('warning', '未加载镜像', '请先加载内存镜像');
                    return;
                }

                // 显示加载
                document.getElementById('loadingOverlay').classList.remove('hidden');
                document.getElementById('loadingText').textContent = '正在执行 ' + pluginId + '...';

                // 模拟延迟
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    this.displayResults(pluginId);
                    this.toast('success', '分析完成', pluginId + ' 执行完成');
                }, 800);
            }

            searchFlag() {
                console.log('searchFlag 被调用');
                if (!this.currentImage) {
                    this.toast('warning', '未加载镜像', '请先加载内存镜像');
                    return;
                }

                document.getElementById('loadingOverlay').classList.remove('hidden');
                document.getElementById('loadingText').textContent = '正在搜索 Flag...';

                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    this.toast('success', '搜索完成', '找到 2 个可能的 Flag');
                }, 600);
            }

            displayResults(pluginId) {
                const mockData = {
                    'pslist': [
                        { pid: 4, ppid: 0, name: 'System', threads: 124, handles: 0, create_time: '2025-01-26 10:00:00' },
                        { pid: 896, ppid: 4, name: 'smss.exe', threads: 3, handles: 45, create_time: '2025-01-26 10:00:05' },
                        { pid: 2456, ppid: 1180, name: 'svchost.exe', threads: 24, handles: 678, create_time: '2025-01-26 10:01:00' },
                        { pid: 3568, ppid: 2456, name: 'docker.exe', threads: 8, handles: 234, create_time: '2025-01-26 10:05:00' }
                    ],
                    'netscan': [
                        { protocol: 'TCP', local_address: '192.168.1.100', local_port: 54321, remote_address: '142.250.185.78', remote_port: 443, state: 'ESTABLISHED', process_name: 'chrome.exe' }
                    ]
                };

                const results = mockData[pluginId] || [];
                this.buildTable(results, pluginId);
            }

            buildTable(results, plugin) {
                document.getElementById('resultsPanel').classList.remove('hidden');
                document.getElementById('resultsEmpty')?.classList.add('hidden');
                document.getElementById('resultsTableContainer').classList.remove('hidden');

                const names = { 'pslist': '进程列表', 'netscan': '网络连接' };
                document.getElementById('resultsTitle').textContent = names[plugin] || plugin.toUpperCase();
                document.getElementById('resultCount').textContent = results.length;
                document.getElementById('executionTime').textContent = '0.80s';

                const columns = plugin === 'pslist'
                    ? ['pid', 'ppid', 'name', 'threads', 'handles', 'create_time']
                    : ['protocol', 'local_address', 'local_port', 'remote_address', 'remote_port', 'state', 'process_name'];

                const headers = plugin === 'pslist'
                    ? ['PID', 'PPID', '进程名', '线程', '句柄', '创建时间']
                    : ['协议', '本地地址', '本地端口', '远程地址', '远程端口', '状态', '进程'];

                let tableHtml = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
                tableHtml += '<tbody>' + results.map(row => '<tr>' + columns.map(col => `<td>${row[col] ?? '-'}</td>`).join('') + '</tr>').join('') + '</tbody>';

                document.getElementById('resultsTableHead').innerHTML = tableHtml.match(/<thead>.*?<\/thead>/)[0];
                document.getElementById('resultsTableBody').innerHTML = tableHtml.match(/<tbody>.*?<\/tbody>/s)[0];
            }

            setSystemStatus(text, type) {
                const dot = document.getElementById('systemStatusDot');
                const statusText = document.getElementById('systemStatusText');

                dot.className = 'status-dot';
                if (type !== 'normal') dot.classList.add(type);
                statusText.textContent = text;
            }

            toast(type, title, message) {
                const icons = {
                    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>',
                    warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                };

                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `
                    <div class="toast-icon ${type}">${icons[type]}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                `;

                document.getElementById('toastContainer').appendChild(toast);

                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                });

                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        // 初始化
        const app = new SimpleApp();
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM 加载完成');
            app.init();
        });
    </script>
</body>
</html>
