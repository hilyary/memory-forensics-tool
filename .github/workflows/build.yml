name: Build with Nuitka (All Platforms)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Nuitka
        run: pip install "nuitka==2.8.10"

      - name: Install dependencies
        run: |
          pip install pywebview python-docx pefile pyyaml rich PySocks

      - name: Build with Nuitka
        run: |
          python -m nuitka --standalone --onefile --assume-yes-for-downloads --output-dir=dist --output-filename=LensAnalysis.exe --jobs=4 --include-data-dir=frontend=frontend --include-package=webview.platforms.edgechromium --include-module=socks --nofollow-import-to=volatility3 --nofollow-import-to=matplotlib --nofollow-import-to=numpy --nofollow-import-to=pandas --nofollow-import-to=scipy --nofollow-import-to=tkinter --windows-disable-console LensAnalysis.py

      - name: List build output
        run: |
          echo "=== dist directory ==="
          dir dist\ || echo "dist directory not found"

      - name: Upload Windows app
        uses: actions/upload-artifact@v4
        with:
          name: LensAnalysis-Windows
          path: dist/LensAnalysis*

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Nuitka
        run: pip install "nuitka==2.8.10"

      - name: Install dependencies
        run: |
          pip install pywebview python-docx pefile pyyaml rich pyobjc-core pyobjc-framework-Cocoa PySocks

      - name: Build with Nuitka (${{ matrix.arch }})
        run: |
          python -m nuitka --standalone --assume-yes-for-downloads \
            --output-dir=dist-${{ matrix.arch }} \
            --output-filename=LensAnalysis \
            --jobs=4 \
            --macos-target-arch=${{ matrix.arch }} \
            --include-data-dir=frontend=frontend \
            --include-package=webview.platforms.cocoa \
            --include-module=socks \
            --include-package=objc \
            --include-module=PyObjCTools \
            --nofollow-import-to=volatility3 \
            --nofollow-import-to=matplotlib \
            --nofollow-import-to=numpy \
            --nofollow-import-to=pandas \
            --nofollow-import-to=scipy \
            --nofollow-import-to=tkinter \
            --macos-create-app-bundle \
            --macos-app-icon=frontend/assets/LensAnalysis-icon.icns \
            --macos-app-name=LensAnalysis \
            --macos-app-version=1.0.0 \
            LensAnalysis.py

      - name: Fix Info.plist for proper GUI app
        run: |
          python3 << 'PYTHON'
          import plistlib
          p = plistlib.load(open('dist-${{ matrix.arch }}/LensAnalysis.app/Contents/Info.plist', 'rb'))
          p['NSPrincipalClass'] = 'NSApplication'
          p['LSBackgroundOnly'] = False
          p['LSUIElement'] = False
          p['NSHighResolutionCapable'] = True
          plistlib.dump(p, open('dist-${{ matrix.arch }}/LensAnalysis.app/Contents/Info.plist', 'wb'))
          print('Info.plist fixed')
          PYTHON

      - name: Re-sign after Info.plist modification
        run: |
          codesign --force --deep --sign - dist-${{ matrix.arch }}/LensAnalysis.app
          echo "重新签名完成"

      - name: Copy PyObjC Python files
        run: |
          echo "=== Copying PyObjC .py files ==="

          # 找到 site-packages 路径
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          echo "Site packages: $SITE_PACKAGES"

          # 创建 objc 目录
          mkdir -p dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/objc
          mkdir -p dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/WebKit

          # 复制 objc 的 .py 文件
          if [ -d "$SITE_PACKAGES/objc" ]; then
            cp "$SITE_PACKAGES/objc/"*.py dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/objc/ 2>/dev/null || true
            echo "Copied objc .py files"
          else
            echo "Warning: objc directory not found at $SITE_PACKAGES/objc"
          fi

          # 复制 Foundation, AppKit, CoreFoundation, WebKit 的 .py 文件
          cp "$SITE_PACKAGES/Foundation/"*.py dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/ 2>/dev/null || true
          cp "$SITE_PACKAGES/AppKit/"*.py dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/ 2>/dev/null || true
          cp "$SITE_PACKAGES/CoreFoundation/"*.py dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/ 2>/dev/null || true
          cp "$SITE_PACKAGES/WebKit/__init__.py" dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/WebKit/ 2>/dev/null || true

          echo "PyObjC files copied"
          ls -la dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/objc/ || echo "objc directory is empty or doesn't exist"

      - name: Fix executable permissions
        run: |
          echo "=== Fixing executable permissions ==="
          # 给 app bundle 内的所有可执行文件添加执行权限
          find dist-${{ matrix.arch }}/LensAnalysis.app -type f -name "*.so" -exec chmod +x {} \;
          find dist-${{ matrix.arch }}/LensAnalysis.app -type f -perm 644 -exec chmod +x {} \;
          # 特别确保主可执行文件有执行权限
          chmod +x dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/* 2>/dev/null || true
          echo "=== Permissions fixed ==="
          ls -la dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/

      - name: Remove quarantine and re-sign
        run: |
          echo "=== Removing quarantine attributes ==="
          # 移除隔离属性，避免双击时无法启动
          xattr -cr dist-${{ matrix.arch }}/LensAnalysis.app
          # 重新签名
          codesign --force --deep --sign - dist-${{ matrix.arch }}/LensAnalysis.app
          echo "=== Done ==="

      - name: Create launcher app for double-click support
        run: |
          echo "=== Creating launcher app ==="

          # 重命名 Nuitka 生成的 app 为实际应用
          mv dist-${{ matrix.arch }}/LensAnalysis.app dist-${{ matrix.arch }}/LensAnalysisRuntime.app

          # 创建启动器 app 结构
          mkdir -p dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS
          mkdir -p dist-${{ matrix.arch }}/LensAnalysis.app/Contents/Resources

          # 复制图标
          cp frontend/assets/LensAnalysis-icon.icns dist-${{ matrix.arch }}/LensAnalysis.app/Contents/Resources/ 2>/dev/null || true

          # 创建 Info.plist
          cat > dist-${{ matrix.arch }}/LensAnalysis.app/Contents/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>LensAnalysisLauncher</string>
              <key>CFBundleIconFile</key>
              <string>LensAnalysis-icon.icns</string>
              <key>CFBundleIdentifier</key>
              <string>com.lensanalysis</string>
              <key>CFBundleName</key>
              <string>LensAnalysis</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>LSUIElement</key>
              <false/>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLIST

          # 创建启动器可执行文件
          cat > dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/LensAnalysisLauncher << 'LAUNCHER'
          #!/bin/bash
          # LensAnalysis 启动器
          # 使用 open 命令启动实际的运行时应用

          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          RUNTIME_APP="$SCRIPT_DIR/LensAnalysisRuntime.app"

          # 检查运行时应用是否存在
          if [ ! -d "$RUNTIME_APP" ]; then
              echo "错误: 找不到 LensAnalysisRuntime.app"
              exit 1
          fi

          # 使用 open 命令启动（和终端运行效果相同）
          open "$RUNTIME_APP"
          LAUNCHER

          chmod +x dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/LensAnalysisLauncher

          # 复制运行时 app 到启动器 app 内部
          cp -R dist-${{ matrix.arch }}/LensAnalysisRuntime.app dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/

          # 移除隔离属性并签名
          xattr -cr dist-${{ matrix.arch }}/LensAnalysis.app
          codesign --force --deep --sign - dist-${{ matrix.arch }}/LensAnalysis.app

          echo "=== Launcher app created ==="
          ls -la dist-${{ matrix.arch }}/LensAnalysis.app/Contents/MacOS/

      - name: List build output
        run: |
          echo "=== dist-${{ matrix.arch }} directory ==="
          ls -la dist-${{ matrix.arch }}/ || echo "dist-${{ matrix.arch }} directory not found"
          echo ""
          echo "=== Looking for LensAnalysis ==="
          find dist-${{ matrix.arch }} -name "LensAnalysis*" -type f -o -name "LensAnalysis*" -type d || echo "No LensAnalysis files found"

      - name: Create DMG
        run: |
          echo "=== Creating DMG for ${{ matrix.arch }} ==="
          # 创建临时目录用于 DMG
          mkdir -p dmg_contents

          # 复制 app 到 DMG 目录
          cp -R dist-${{ matrix.arch }}/LensAnalysis.app dmg_contents/

          # 创建 Applications 文件夹的符号链接（方便拖拽安装）
          ln -s /Applications dmg_contents/Applications

          # 创建 DMG（使用 UDZO 格式，兼容性更好）
          hdiutil create -volname "LensAnalysis (${{ matrix.arch }})" \
                         -srcfolder dmg_contents \
                         -ov -format UDZO \
                         -imagekey zlib-level=9 \
                         "dist-${{ matrix.arch }}/LensAnalysis-1.0.0-macOS-${{ matrix.arch }}.dmg"

          # 清理
          rm -rf dmg_contents

          echo "DMG created:"
          ls -la dist-${{ matrix.arch }}/*.dmg

      - name: Upload macOS app and DMG (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: LensAnalysis-macOS-${{ matrix.arch }}
          path: |
            dist-${{ matrix.arch }}/LensAnalysis.app
            dist-${{ matrix.arch }}/*.dmg
