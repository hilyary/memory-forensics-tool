name: Build with Nuitka (All Platforms)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # build-windows:
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.9'
  #
  #     - name: Install Nuitka
  #       run: pip install nuitka
  #
  #     - name: Install dependencies
  #       run: |
  #         pip install pywebview python-docx pefile pyyaml rich
  #
  #     - name: Build with Nuitka
  #       run: |
  #         python -m nuitka --standalone --onefile --assume-yes-for-downloads --output-dir=dist --output-filename=LensAnalysis.exe --jobs=4 --include-data-dir=frontend=frontend --include-data-dir=backend/scripts=backend/scripts --plugin-disable=pywebview --include-module=webview --include-module=webview.platforms.edgechromium --nofollow-import-to=volatility3 --nofollow-import-to=matplotlib --nofollow-import-to=numpy --nofollow-import-to=pandas --nofollow-import-to=scipy --nofollow-import-to=tkinter --windows-disable-console LensAnalysis.py
  #
  #     - name: List build output
  #       run: |
  #         echo "=== dist directory ==="
  #         dir dist\ || echo "dist directory not found"
  #
  #     - name: Upload Windows app
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: LensAnalysis-Windows
  #         path: dist/LensAnalysis*

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Nuitka
        run: pip install "nuitka==2.5.5"

      - name: Install dependencies
        run: |
          pip install pywebview python-docx pefile pyyaml rich pyobjc-core pyobjc-framework-Cocoa PySocks

      - name: Build with Nuitka
        run: |
          python -m nuitka --standalone --assume-yes-for-downloads \
            --output-dir=dist \
            --output-filename=LensAnalysis \
            --jobs=4 \
            --include-data-dir=frontend=frontend \
            --include-package=webview.platforms.cocoa \
            --include-module=socks \
            --include-package=objc \
            --include-module=PyObjCTools \
            --nofollow-import-to=volatility3 \
            --nofollow-import-to=matplotlib \
            --nofollow-import-to=numpy \
            --nofollow-import-to=pandas \
            --nofollow-import-to=scipy \
            --nofollow-import-to=tkinter \
            --macos-create-app-bundle \
            --macos-app-icon=frontend/assets/LensAnalysis-icon.icns \
            --macos-app-name=LensAnalysis \
            --macos-app-version=1.0.0 \
            LensAnalysis.py

      - name: Copy PyObjC Python files
        run: |
          echo "=== Copying PyObjC .py files ==="

          # 找到 site-packages 路径
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          echo "Site packages: $SITE_PACKAGES"

          # 创建 objc 目录
          mkdir -p dist/LensAnalysis.app/Contents/MacOS/objc
          mkdir -p dist/LensAnalysis.app/Contents/MacOS/WebKit

          # 复制 objc 的 .py 文件
          if [ -d "$SITE_PACKAGES/objc" ]; then
            cp "$SITE_PACKAGES/objc/"*.py dist/LensAnalysis.app/Contents/MacOS/objc/ 2>/dev/null || true
            echo "Copied objc .py files"
          else
            echo "Warning: objc directory not found at $SITE_PACKAGES/objc"
          fi

          # 复制 Foundation, AppKit, CoreFoundation, WebKit 的 .py 文件
          cp "$SITE_PACKAGES/Foundation/"*.py dist/LensAnalysis.app/Contents/MacOS/ 2>/dev/null || true
          cp "$SITE_PACKAGES/AppKit/"*.py dist/LensAnalysis.app/Contents/MacOS/ 2>/dev/null || true
          cp "$SITE_PACKAGES/CoreFoundation/"*.py dist/LensAnalysis.app/Contents/MacOS/ 2>/dev/null || true
          cp "$SITE_PACKAGES/WebKit/__init__.py" dist/LensAnalysis.app/Contents/MacOS/WebKit/ 2>/dev/null || true

          echo "PyObjC files copied"
          ls -la dist/LensAnalysis.app/Contents/MacOS/objc/ || echo "objc directory is empty or doesn't exist"

      - name: Fix executable permissions
        run: |
          echo "=== Fixing executable permissions ==="
          # 给 app bundle 内的所有可执行文件添加执行权限
          find dist/LensAnalysis.app -type f -name "*.so" -exec chmod +x {} \;
          find dist/LensAnalysis.app -type f -perm 644 -exec chmod +x {} \;
          # 特别确保主可执行文件有执行权限
          chmod +x dist/LensAnalysis.app/Contents/MacOS/* 2>/dev/null || true
          # 移除隔离属性（避免 macOS Gatekeeper 阻止）
          xattr -d com.apple.quarantine dist/LensAnalysis.app 2>/dev/null || true
          # Ad-hoc 代码签名（允许双击打开）
          codesign --force --deep --sign - dist/LensAnalysis.app
          echo "=== Permissions fixed ==="
          ls -la dist/LensAnalysis.app/Contents/MacOS/

      - name: List build output
        run: |
          echo "=== dist directory ==="
          ls -la dist/ || echo "dist directory not found"
          echo ""
          echo "=== Looking for LensAnalysis ==="
          find dist -name "LensAnalysis*" -type f -o -name "LensAnalysis*" -type d || echo "No LensAnalysis files found"

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: LensAnalysis-macOS
          path: dist/LensAnalysis*
